<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
 
	<title>Student Marks Entry</title>
	
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	
	<!-- Bootstrap CDN -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

	<!-- jQuery CDN -->
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>
	<div th:replace="~{/navbar :: navbar}"></div>

	<div class="container mt-4">
		<h2>Student Marks Entry</h2>
		
		<!-- Flash Messages -->
			<div class="mt-3">
				<div th:if="${success}" class="alert alert-success" th:utext="${success}"></div>
				<div th:if="${error}" class="alert alert-danger" th:utext="${error}"></div>
			</div>

		<!-- Filter Form -->

		<div class="card shadow-card p-3 h-100">
			<form id="QuestionsForm">
				<input type="hidden" id="studentId">
				<div class="row">
					<input type="hidden" id="studentId">
					<div class="row">
						<div class="col-md-6">
							<label class="form-label">Department:</label>
							<input type="text" class="form-control" id="department" readonly>
						</div>
						<div class="col-md-6">
							<label class="form-label">Batch:</label>
							<input type="text" class="form-control" id="batch" readonly>
						</div>
					</div>
				</div>
				<div class="row mt-3">
					<div class="col-md-4">
						<label class="form-label">Semester:</label>
						<select class="form-control" id="semester">
							<option value="">-- Select Semester --</option>
							<option th:each="s : ${#numbers.sequence(1,8)}" th:value="${s}" th:text="${s}">
							</option>
						</select>
					</div>
					<div class="col-md-4">
						<label class="form-label">Subject:</label>
						<select class="form-control" id="subject" disabled>
							<option value="">-- Select Subject --</option>
						</select>
					</div>
					<div class="col-md-4">
						<label class="form-label">Exam Type:</label>
						<select class="form-control" id="examType">
							<option value="">-- Select Exam Type --</option>
							<option value="CAT 1">CAT 1</option>
							<option value="CAT 2">CAT 2</option>
							<option value="Model">Model</option>
							<option value="CAT 1 Lab">CAT 1 Lab</option>
							<option value="CAT 2 Lab">CAT 2 Lab</option>
							<option value="Model Lab">Model Lab</option>
						</select>
					</div>
				</div>
				<button type="button" class="btn btn-success mt-3" id="loadQuestionsBtn">Load Questions</button>
				<div id="questionsContainer" class="mt-4"></div>
				<!-- Common Submit Button -->
				<button type="button" class="btn btn-primary mt-3" id="commonSubmitBtn" style="display: none;">Submit
					Marks</button>
			</form>
		</div>

	</div>

	<script>
		// Load subjects based on department and semester
		$('#department, #semester').on('change', function () {
			const department = $('#department').val();
			const semester = $('#semester').val();

			if (department && semester) {
				$.ajax({
					url: '/subjects/by-dept-sem',
					method: 'GET',
					data: {department: department, semester: semester},
					success: function (subjects) {
						const subjectSelect = $('#subject');
						subjectSelect.empty().append('<option value="">Select Subject</option>');

						if (subjects.length > 0) {
							subjects.forEach(sub => {
								subjectSelect.append(`<option value="${sub.name}">${sub.name}</option>`);
							});
						} else {
							subjectSelect.append('<option disabled>No subjects found</option>');
						}

						subjectSelect.prop('disabled', false);
					},
					error: function () {
						alert("Failed to load subjects.");
					}
				});
			} else {
				$('#subject').empty().append('<option value="">Select Subject</option>').prop('disabled', true);
			}
		});

		// Common function to load questions and render table
		function loadQuestionsTable({department, batch, semester, examType, subject, studentId}) {
			$.get(`/student-marks/filtered?department=${department}&batch=${batch}&semester=${semester}&examType=${examType}&subject=${subject}&studentId=${studentId}`, function (data) {
				let html = `<h4>Questions and Marks</h4>
	                <table class="table table-bordered">
	                    <thead>
	                        <tr>
								<th>Part</th>
	                            <th>Question Number</th>
	                            <th>Question Text</th>
	                            <th>Max Marks</th>
	                            <th>Submitted Marks</th>
	                        </tr>
	                    </thead>
	                    <tbody>`;

				data.questions.forEach(q => {
					const submittedMark = data.submittedMarks?.find(mark => mark.questionId === q.id)?.answer;

					let markCell;
					if (submittedMark !== undefined) {
						markCell = submittedMark;
					} else {
						markCell = `
							<select class="form-control marks-input" data-question-id="${q.id}">
								<option value="">-- Select --</option>
								<option value="N">N</option>
								<option value="AB">AB</option>
								${Array.from({length: q.maxMarks + 1}, (_, i) => `<option value="${i}">${i}</option>`).join('')}
							</select>`;
					}

					html += `
	                    <tr>
							<td>${q.part}</td>
	                        <td>${q.questionNumber}</td>
	                        <td>${q.text}</td>
	                        <td>${q.maxMarks}</td>
	                        <td>${markCell}</td>
	                    </tr>`;
				});

				html += `</tbody></table>`;
				$('#questionsContainer').html(html);

				// Show submit button only if there are unsubmitted questions
				const hasPendingMarks = data.questions.some(q =>
					!data.submittedMarks?.some(mark => mark.questionId === q.id)
				);

				if (hasPendingMarks) {
					$('#commonSubmitBtn').show();
				} else {
					$('#commonSubmitBtn').hide();
				}
			});
		}

		$(document).ready(function () {
			// Load Student Department & Batch
			$.get("/student-marks/details", function (data) {
				$('#department').val(data.department.name);
				$('#batch').val(data.batch.name);
				$('#studentId').val(data.studentId || '');
			});

			// Enable Subject Dropdown After Semester Selection
			$('#semester').change(function () {
				$('#subject').prop('disabled', false);
			});

			// Load Questions Button Click
			$('#loadQuestionsBtn').click(function () {
				const department = $('#department').val();
				const batch = $('#batch').val();
				const semester = $('#semester').val();
				const examType = $('#examType').val();
				const subject = $('#subject').val();
				const studentId = $('#studentId').val();

				if (!semester || !examType || !subject) {
					alert("Please select Semester, Exam Type, and Subject.");
					return;
				}

				loadQuestionsTable({department, batch, semester, examType, subject, studentId});
			});

			// Submit Marks Button Click
			$('#commonSubmitBtn').click(function () {
				const studentId = $('#studentId').val();
				if (!studentId) {
					alert("Error: Student ID is missing.");
					return;
				}

				const marksData = [];

				$('.marks-input').each(function () {
					const marks = $(this).val();
					const questionId = $(this).data('question-id');

					if (marks) {
						marksData.push({
							question: {id: questionId},
							answer: marks
						});
					}
				});

				if (marksData.length === 0) {
					alert("No new marks selected to submit.");
					return;
				}
				
				const confirmSubmit = confirm("Are you sure you want to submit the marks?");
					if (!confirmSubmit) {
						return;
					}

				$.ajax({
					url: '/student-marks/submit',
					type: 'POST',
					contentType: 'application/json',
					data: JSON.stringify(marksData),
					success: function (response) {
						alert(response);

						// Reload updated question table with same data
						const department = $('#department').val();
						const batch = $('#batch').val();
						const semester = $('#semester').val();
						const examType = $('#examType').val();
						const subject = $('#subject').val();

						loadQuestionsTable({department, batch, semester, examType, subject, studentId});
					},
					error: function () {
						alert("Error submitting marks.");
					}
				});
			});
		});
	</script>

</body>

</html>