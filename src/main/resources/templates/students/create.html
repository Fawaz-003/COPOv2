<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <title>Add Student</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Bootstrap CDN -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- jQuery and Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </head>

  <body>
    <div th:replace="~{/navbar :: navbar}"></div>

    <!-- Flash Messages -->
    <div class="mt-3">
      <div
        th:if="${success}"
        class="alert alert-success"
        th:utext="${success}"
      ></div>
      <div
        th:if="${error}"
        class="alert alert-danger"
        th:utext="${error}"
      ></div>
    </div>

    <div class="container mt-5">
      <div class="row justify-content-center">
        <div class="col-md-8">
          <div class="card shadow-lg">
            <div class="card-header bg-primary text-white">
              <h4 class="mb-0">Add New Student</h4>
            </div>
            <div class="card-body">
              <!-- Error Message -->
              <div
                th:if="${error}"
                class="alert alert-danger"
                th:text="${error}"
              ></div>

              <!-- Form -->
              <form
                th:action="@{/students}"
                th:object="${student}"
                method="post"
                onsubmit="return confirmSave();"
              >
                <div class="mb-3">
                  <label for="name" class="form-label">Name</label>
                  <input
                    type="text"
                    id="name"
                    name="name"
                    class="form-control"
                    th:field="*{name}"
                    required
                  />
                </div>

                <div class="mb-3">
                  <label for="rollNumber" class="form-label">Roll Number</label>
                  <input
                    type="text"
                    id="rollNumber"
                    name="rollNumber"
                    class="form-control"
                    th:field="*{rollNumber}"
                    required
                  />
                </div>

                <div class="mb-3">
                  <label for="registerNumber" class="form-label"
                    >Register Number</label
                  >
                  <input
                    type="text"
                    id="registerNumber"
                    name="registerNumber"
                    class="form-control"
                    th:field="*{registerNumber}"
                    required
                  />
                </div>

                <div class="mb-3">
                  <label for="dob" class="form-label">Date of Birth</label>
                  <input
                    type="date"
                    id="dob"
                    name="dob"
                    class="form-control"
                    th:field="*{dob}"
                    required
                  />
                </div>

                <div class="mb-3">
                  <label for="department" class="form-label">Department</label>
                  <select
                    id="department"
                    name="department.id"
                    class="form-select"
                    th:field="*{department.id}"
                    required
                  >
                    <option value="">-- Select Department --</option>
                    <option
                      th:each="dept : ${departments}"
                      th:value="${dept.id}"
                      th:text="${dept.name}"
                    ></option>
                  </select>
                </div>

                <div class="mb-3">
                  <label for="section" class="form-label">Section</label>
                  <select
                    id="section"
                    name="section.id"
                    class="form-select"
                    th:field="*{section.id}"
                    required
                  >
                    <option value="">-- Select Department First --</option>
                  </select>
                </div>

                <div class="mb-3">
                  <label for="batch" class="form-label">Batch</label>
                  <select
                    id="batch"
                    name="batch.id"
                    class="form-select"
                    th:field="*{batch.id}"
                    required
                  >
                    <option value="">-- Select Batch --</option>
                    <option
                      th:each="batch : ${batches}"
                      th:value="${batch.id}"
                      th:text="${batch.name}"
                    ></option>
                  </select>
                </div>

                <div class="d-flex justify-content-between">
                  <button type="submit" class="btn btn-success">Save</button>
                  <a href="/students" class="btn btn-secondary">Back to List</a>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      function confirmSave() {
        return confirm("Are you sure you want to save?");
      }

      $(document).ready(function () {
        // When department changes, load corresponding sections
        $("#department").change(function () {
          var departmentId = $(this).val();
          var sectionSelect = $("#section");

          // Clear existing options
          sectionSelect.empty();

          if (departmentId) {
            // Show loading message
            sectionSelect.append(
              '<option value="">-- Loading Sections... --</option>'
            );

            // Fetch sections for selected department
            $.ajax({
              url: "/students/sections?departmentId=" + departmentId,
              type: "GET",
              success: function (data) {
                sectionSelect.empty();
                sectionSelect.append(
                  '<option value="">-- Select Section --</option>'
                );

                // Add sections to dropdown
                $.each(data, function (index, section) {
                  sectionSelect.append(
                    '<option value="' +
                      section.id +
                      '">' +
                      section.sectionName +
                      "</option>"
                  );
                });
              },
              error: function () {
                sectionSelect.empty();
                sectionSelect.append(
                  '<option value="">-- Error Loading Sections --</option>'
                );
              },
            });
          } else {
            sectionSelect.append(
              '<option value="">-- Select Department First --</option>'
            );
          }
        });
      });
    </script>
  </body>
</html>
